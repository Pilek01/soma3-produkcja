<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statystyki Produkcji - Flexo PRO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #ff6b35;
            --accent-hover: #ff8555;
            --border: #404040;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #f59e0b;
            
            --kamil: #7bed9f;
            --kamil-dark: #2ed573;
            --igor: #ffa502;
            --igor-dark: #ff7f00;
            --jarek: #70a1ff;
            --jarek-dark: #1e90ff;
            --wowa: #ff6348;
            --wowa-dark: #ff4757;
        }

        body.light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border: #cccccc;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 3px solid var(--accent);
            padding: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .view-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .view-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border);
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .view-btn:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .view-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* KPI Dashboard Styles */
        .kpi-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .kpi-icon {
            font-size: 2rem;
        }

        .kpi-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .kpi-change {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kpi-change.positive {
            color: var(--success);
        }

        .kpi-change.negative {
            color: var(--danger);
        }

        .kpi-change.neutral {
            color: var(--warning);
        }

        /* Advanced Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .chart-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .chart-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .chart-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
            width: 100%;
        }

        /* Excel Export Button */
        .excel-btn {
            background: linear-gradient(135deg, #217346 0%, #2d9c5e 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .excel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 115, 70, 0.4);
        }

        /* Cloud Sync Indicator */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .sync-status.synced {
            border-left: 3px solid var(--success);
        }

        .sync-status.syncing {
            border-left: 3px solid var(--warning);
        }

        .sync-status.error {
            border-left: 3px solid var(--danger);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sync-dot.synced {
            background: var(--success);
        }

        .sync-dot.syncing {
            background: var(--warning);
        }

        .sync-dot.error {
            background: var(--danger);
        }

        /* Analysis Cards */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analysis-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .analysis-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-label {
            color: var(--text-secondary);
        }

        .analysis-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Existing styles from original app */
        .month-selector {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .month-nav button {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .month-nav button:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .month-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .progress-bar-container {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .progress-bar-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .day-complete {
            color: var(--success);
            font-size: 0.9rem;
        }

        .day-incomplete {
            color: var(--accent);
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--bg-tertiary);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-hover) 100%);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .calendar-table {
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow-x: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg-tertiary);
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            border: 1px solid var(--border);
        }

        td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }

        td:hover {
            background: var(--bg-tertiary);
        }

        .day-cell {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .day-indicator {
            margin-left: 0.3rem;
            font-size: 1rem;
        }

        .today-row {
            outline: 3px solid var(--accent);
            outline-offset: -3px;
        }

        .today-row td {
            background: rgba(255, 107, 53, 0.15) !important;
        }

        .shift-1 { color: #ffd700; }
        .shift-2 { color: #ff6b35; }
        .shift-3 { color: #9b59b6; }
        .shift-free { color: var(--text-secondary); opacity: 0.5; }

        .production-value {
            font-weight: 700;
            font-size: 1rem;
        }

        .kamil-cell { background: rgba(123, 237, 159, 0.1); }
        .igor-cell { background: rgba(255, 165, 2, 0.1); }
        .jarek-cell { background: rgba(112, 161, 255, 0.1); }
        .wowa-cell { background: rgba(255, 99, 72, 0.1); }
        
        .free-day-cell {
            background: rgba(60, 60, 60, 0.4) !important;
            opacity: 0.6;
        }
        
        .sum-cell {
            background: rgba(255, 215, 0, 0.15);
            font-weight: 700;
            border-left: 3px solid rgba(255, 215, 0, 0.6);
        }
        
        .today-row .sum-cell {
            background: rgba(255, 215, 0, 0.25);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            overflow-y: auto;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--accent);
            border-bottom: 2px solid var(--border);
            padding-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .edit-schedule-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .edit-schedule-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .edit-schedule-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .schedule-editor {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 2px solid var(--accent);
            max-height: 60vh;
            overflow-y: auto;
        }

        .schedule-editor-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .worker-schedule-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 5px;
        }

        .worker-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .worker-schedule-name {
            flex: 1;
            font-weight: 700;
        }

        .shift-selector {
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 5px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .holiday-checkbox {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #ff6b35 0%, #ff8555 100%);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .holiday-checkbox:hover {
            border-color: #ff6b35;
            transform: translateY(-2px);
        }

        .holiday-checkbox.active {
            background: linear-gradient(135deg, #f44336 0%, #ff5252 100%);
            border-color: #f44336;
        }

        .holiday-checkbox input {
            width: 32px;
            height: 32px;
            cursor: pointer;
        }

        .holiday-checkbox label {
            cursor: pointer;
            font-weight: 700;
            font-size: 1.2rem;
            color: white;
            flex: 1;
        }

        .custom-schedule-indicator {
            color: var(--accent);
            font-size: 0.8rem;
            margin-left: 0.3rem;
        }

        .reset-schedule-btn {
            background: var(--danger);
            border: 2px solid var(--danger);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 1rem;
            width: 100%;
        }

        .reset-schedule-btn:hover {
            background: #d32f2f;
            border-color: #d32f2f;
            transform: translateY(-2px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .worker-input {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .worker-label {
            flex: 1;
            font-weight: 700;
            padding: 0.5rem;
            border-radius: 5px;
        }

        .kamil-label { background: var(--kamil); color: #000; }
        .igor-label { background: var(--igor); color: #000; }
        .jarek-label { background: var(--jarek); color: #fff; }
        .wowa-label { background: var(--wowa); color: #fff; }

        .shift-indicator {
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 150px;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .summary-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .summary-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .stat-card.kamil { border-left-color: var(--kamil-dark); }
        .stat-card.igor { border-left-color: var(--igor-dark); }
        .stat-card.jarek { border-left-color: var(--jarek-dark); }
        .stat-card.wowa { border-left-color: var(--wowa-dark); }
        .stat-card.total { border-left-color: var(--accent); }

        .stat-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .yearly-table {
            width: 100%;
            margin-top: 2rem;
            overflow-x: auto;
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .yearly-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .yearly-table th {
            background: var(--bg-primary);
            padding: 1rem;
            font-weight: 700;
            border: 1px solid var(--border);
            text-align: center;
        }

        .yearly-table td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid var(--border);
        }

        .yearly-table tbody tr {
            transition: background 0.3s;
        }

        .yearly-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .yearly-table .total-row {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a1a;
            font-weight: 700;
        }

        .yearly-table .total-row td {
            padding: 1rem;
            border-color: #ffd700;
        }
        
        .yearly-table .kamil-col { background: rgba(123, 237, 159, 0.05); }
        .yearly-table .igor-col { background: rgba(255, 165, 2, 0.05); }
        .yearly-table .jarek-col { background: rgba(112, 161, 255, 0.05); }
        .yearly-table .wowa-col { background: rgba(255, 99, 72, 0.05); }
        .yearly-table .sum-col { background: rgba(255, 215, 0, 0.1); font-weight: 600; }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .year-selector select {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .title {
                font-size: 1.3rem;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 0.5rem 0.25rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .kpi-dashboard {
                grid-template-columns: 1fr;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        .toast {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideInRight 0.3s, fadeOut 0.3s 2.7s;
            font-weight: 600;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        .total-card {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a1a;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
        }

        .total-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .total-value {
            font-size: 3rem;
            font-weight: 700;
        }

        .total-subtitle {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }

        .forecast-card {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .forecast-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .forecast-value {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .forecast-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }

        .podium-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .podium-card {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid;
            position: relative;
            transition: transform 0.3s;
        }

        .podium-card:hover {
            transform: translateY(-4px);
        }

        .podium-card.rank-1 { 
            border-left-color: #ffd700;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
        }

        .podium-card.rank-2 { 
            border-left-color: #c0c0c0;
            box-shadow: 0 4px 20px rgba(192, 192, 192, 0.2);
        }

        .podium-card.rank-3 { 
            border-left-color: #cd7f32;
            box-shadow: 0 4px 20px rgba(205, 127, 50, 0.2);
        }

        .podium-card.rank-4 { 
            border-left-color: var(--border);
        }

        .podium-rank {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2.5rem;
        }

        .podium-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            padding-right: 3rem;
        }

        .podium-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .podium-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .comparison-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
        }

        .comparison-text.trend-up {
            color: var(--success);
        }

        .comparison-text.trend-down {
            color: var(--danger);
        }

        .comparison-text.trend-stable {
            color: var(--warning);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="title">📊 Statystyki Produkcji Flexo PRO</div>
            <div class="header-controls">
                <div class="sync-status synced" id="syncStatus">
                    <div class="sync-dot synced"></div>
                    <span id="syncText">Zsynchronizowano</span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">🌓</button>
                <button class="excel-btn" onclick="exportToExcel()">📊 Export Excel</button>
                <button class="btn btn-secondary" onclick="exportData()">💾 Backup</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">📥 Import</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
    </div>

    <div class="container">
        <div class="view-selector">
            <button class="view-btn active" onclick="showView('dashboard')">📊 Dashboard</button>
            <button class="view-btn" onclick="showView('monthly')">📅 Miesięczny</button>
            <button class="view-btn" onclick="showView('yearly')">📈 Roczny</button>
            <button class="view-btn" onclick="showView('analytics')">🔬 Analityka</button>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView">
            <!-- Monthly Goal Progress Bar -->
            <div class="progress-bar-container" style="margin-bottom: 2rem;">
                <div class="progress-bar-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>🎯 Realizacja celu miesięcznego</span>
                    <button class="chart-btn" onclick="openGoalSettings()" style="font-size: 1.2rem; padding: 0.5rem 1rem;" title="Ustaw cel miesięczny">
                        ⚙️
                    </button>
                </div>
                <div id="monthlyGoalInfo" style="margin-bottom: 1rem; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;"></div>
                <div class="progress-bar" style="height: 40px; border-radius: 20px;">
                    <div id="goalProgressFill" class="progress-fill" style="font-size: 1.1rem;"></div>
                </div>
                <div id="goalStatusMessage" style="margin-top: 1rem; font-size: 0.95rem; font-weight: 600;"></div>
            </div>
            
            <div class="kpi-dashboard" id="kpiDashboard"></div>
            
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">📈 Trend produkcji (3 miesiące)</div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="dashboardTrendChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">👥 Porównanie wydajności</div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="dashboardPerformanceChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="summary-section">
                <div class="summary-title">🏆 Top Performers - Bieżący miesiąc</div>
                <div class="podium-section" id="dashboardPodium"></div>
            </div>
        </div>

        <!-- Monthly View -->
        <div id="monthlyView" style="display: none;">
            <div class="month-selector">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">◀</button>
                    <div class="month-display" id="monthDisplay"></div>
                    <button onclick="changeMonth(1)">▶</button>
                </div>
                <div class="year-selector">
                    <select id="yearSelect" onchange="changeYear()">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
            </div>

            <div class="progress-bar-container" id="progressBar"></div>

            <div class="calendar-table" id="calendarTable"></div>

            <div class="summary-section">
                <div class="summary-title">📊 Podsumowanie miesiąca</div>
                
                <div id="totalCard"></div>
                
                <div class="podium-section" id="monthlyStats"></div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">📊 Porównanie produkcji</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">📈 Trend produkcji w miesiącu</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="forecastCard"></div>
            </div>
        </div>

        <!-- Yearly View -->
        <div id="yearlyView" style="display: none;">
            <div class="summary-section">
                <div class="summary-title">📈 Podsumowanie roczne <span id="yearlyTitle"></span></div>
                
                <div id="yearlyTotalCard"></div>
                
                <div class="podium-section" id="yearlyStats"></div>
                
                <div class="yearly-table" id="yearlyTable"></div>
            </div>
        </div>

        <!-- Analytics View -->
        <div id="analyticsView" style="display: none;">
            <div class="summary-section">
                <div class="summary-title">🔬 Zaawansowana analityka</div>
                
                <div class="analysis-grid" id="analysisCards"></div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">📊 Efektywność według zmian</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="shiftEfficiencyChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">📈 Wzrost rok do roku</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="yoyGrowthChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">🎯 Ranking według średniej</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="averageRankingChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">📊 Rozkład produkcji (z całego roku)</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="productionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle"></div>
            <div id="modalBody"></div>
            <div class="button-group" id="modalButtons"></div>
        </div>
    </div>

    <div id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBPTLyd2I85EU3Lzz9qEbgyyLvsRqAX0qM",
            authDomain: "produkcja-soma3.firebaseapp.com",
            databaseURL: "https://produkcja-soma3-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "produkcja-soma3",
            storageBucket: "produkcja-soma3.firebasestorage.app",
            messagingSenderId: "498222138395",
            appId: "1:498222138395:web:15af1c41984e21d810e4be",
            measurementId: "G-E71J31HVWH"
        };

        // Initialize Firebase
        let firebaseApp;
        let database;
        let isFirebaseInitialized = false;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            isFirebaseInitialized = true;
            console.log('✅ Firebase initialized successfully');
        } catch (error) {
            console.error('❌ Firebase initialization error:', error);
            isFirebaseInitialized = false;
        }

        // Constants and initial setup
        const CYCLE_START_DATES = {
            'Kamil': new Date('2025-01-04'),
            'Igor': new Date('2025-01-16'),
            'Wowa': new Date('2025-01-08'),
            'Jarek': new Date('2025-01-12')
        };

        const SHIFT_CYCLE = [1,1,1,1,0,3,3,3,3,0,0,2,2,2,2,0];
        const CYCLE_LENGTH = 16;

        const MONTHS = ['Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec', 
                       'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'];
        
        const WORKERS = ['Kamil', 'Igor', 'Jarek', 'Wowa'];

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDay = null;
        let comparisonChart = null;
        let trendChart = null;
        let dashboardTrendChart = null;
        let dashboardPerformanceChart = null;
        let shiftEfficiencyChart = null;
        let yoyGrowthChart = null;
        let averageRankingChart = null;
        let distributionChart = null;
        let editMode = false;
        let currentView = 'dashboard';

        // Cloud sync simulation
        let syncInterval = null;

        function initCloudSync() {
            // Simulate cloud sync - w produkcji tutaj byłaby integracja z Firebase/Supabase
            syncInterval = setInterval(() => {
                const syncStatus = document.getElementById('syncStatus');
                const syncText = document.getElementById('syncText');
                
                syncStatus.className = 'sync-status syncing';
                syncStatus.querySelector('.sync-dot').className = 'sync-dot syncing';
                syncText.textContent = 'Synchronizuję...';
                
                setTimeout(() => {
                    syncStatus.className = 'sync-status synced';
                    syncStatus.querySelector('.sync-dot').className = 'sync-dot synced';
                    syncText.textContent = 'Zsynchronizowano ' + new Date().toLocaleTimeString();
                }, 1000);
            }, 60000); // Co minutę
        }

        function getCustomSchedule(dayKey) {
            const customSchedules = JSON.parse(localStorage.getItem('customSchedules') || '{}');
            return customSchedules[dayKey] || null;
        }

        function setCustomSchedule(dayKey, schedule) {
            const customSchedules = JSON.parse(localStorage.getItem('customSchedules') || '{}');
            customSchedules[dayKey] = schedule;
            localStorage.setItem('customSchedules', JSON.stringify(customSchedules));
        }

        function deleteCustomSchedule(dayKey) {
            const customSchedules = JSON.parse(localStorage.getItem('customSchedules') || '{}');
            delete customSchedules[dayKey];
            localStorage.setItem('customSchedules', JSON.stringify(customSchedules));
        }

        function getShiftForDay(worker, date) {
            const dayKey = getDayKey(date.getFullYear(), date.getMonth(), date.getDate());
            const customSchedule = getCustomSchedule(dayKey);
            
            if (customSchedule && customSchedule.workers && customSchedule.workers[worker] !== undefined) {
                return customSchedule.workers[worker];
            }
            
            return getShift(worker, date);
        }

        function isDayHoliday(dayKey) {
            const customSchedule = getCustomSchedule(dayKey);
            return customSchedule && customSchedule.isHoliday == true;
        }

        function getShift(worker, date) {
            const startDate = CYCLE_START_DATES[worker];
            
            const dateUTC = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
            const startUTC = Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            
            const diffTime = dateUTC - startUTC;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 0;
            
            const cycleDay = diffDays % CYCLE_LENGTH;
            return SHIFT_CYCLE[cycleDay];
        }

        function initData() {
            if (!localStorage.getItem('productionData')) {
                localStorage.setItem('productionData', JSON.stringify({}));
            }
        }

        function getProductionData() {
            const localData = localStorage.getItem('productionData');
            return localData ? JSON.parse(localData) : {};
        }

        function setProductionData(data) {
            localStorage.setItem('productionData', JSON.stringify(data));
            
            // Sync to Firebase
            if (isFirebaseInitialized) {
                syncToFirebase('productionData', data);
            }
        }

        // Firebase Sync Functions
        function syncToFirebase(key, data) {
            if (!isFirebaseInitialized) return;
            
            try {
                database.ref(key).set(data);
                updateSyncStatus('synced', 'Zsynchronizowano');
            } catch (error) {
                console.error('Firebase sync error:', error);
                updateSyncStatus('error', 'Błąd synchronizacji');
            }
        }

        function loadFromFirebase() {
            if (!isFirebaseInitialized) {
                console.log('Firebase not initialized, using localStorage only');
                return;
            }
            
            updateSyncStatus('syncing', 'Pobieranie danych...');
            
            // Load production data
            database.ref('productionData').once('value', (snapshot) => {
                const firebaseData = snapshot.val();
                if (firebaseData) {
                    localStorage.setItem('productionData', JSON.stringify(firebaseData));
                    console.log('✅ Production data loaded from Firebase');
                }
                updateSyncStatus('synced', 'Zsynchronizowano');
                
                // Refresh current view
                if (currentView === 'dashboard') {
                    renderDashboard();
                } else if (currentView === 'monthly') {
                    renderCalendar();
                } else if (currentView === 'yearly') {
                    renderYearlyStats();
                } else if (currentView === 'analytics') {
                    renderAnalytics();
                }
            }).catch((error) => {
                console.error('Error loading from Firebase:', error);
                updateSyncStatus('error', 'Błąd pobierania');
            });
            
            // Load custom schedules
            database.ref('customSchedules').once('value', (snapshot) => {
                const firebaseSchedules = snapshot.val();
                if (firebaseSchedules) {
                    localStorage.setItem('customSchedules', JSON.stringify(firebaseSchedules));
                    console.log('✅ Custom schedules loaded from Firebase');
                }
            });
            
            // Load monthly goal
            database.ref('monthlyGoal').once('value', (snapshot) => {
                const firebaseGoal = snapshot.val();
                if (firebaseGoal) {
                    localStorage.setItem('monthlyGoal', firebaseGoal);
                    console.log('✅ Monthly goal loaded from Firebase');
                }
            });
        }

        function setupFirebaseListeners() {
            if (!isFirebaseInitialized) return;
            
            // Listen for production data changes
            database.ref('productionData').on('value', (snapshot) => {
                const firebaseData = snapshot.val();
                if (firebaseData) {
                    const localData = getProductionData();
                    const localJson = JSON.stringify(localData);
                    const firebaseJson = JSON.stringify(firebaseData);
                    
                    // Only update if data is different (avoid infinite loops)
                    if (localJson !== firebaseJson) {
                        localStorage.setItem('productionData', firebaseJson);
                        console.log('🔄 Production data updated from Firebase');
                        updateSyncStatus('synced', 'Zaktualizowano');
                        
                        // Refresh current view
                        if (currentView === 'dashboard') {
                            renderDashboard();
                        } else if (currentView === 'monthly') {
                            renderCalendar();
                        } else if (currentView === 'yearly') {
                            renderYearlyStats();
                        } else if (currentView === 'analytics') {
                            renderAnalytics();
                        }
                    }
                }
            });
            
            // Listen for custom schedules changes
            database.ref('customSchedules').on('value', (snapshot) => {
                const firebaseSchedules = snapshot.val();
                if (firebaseSchedules) {
                    localStorage.setItem('customSchedules', JSON.stringify(firebaseSchedules));
                }
            });
            
            // Listen for monthly goal changes
            database.ref('monthlyGoal').on('value', (snapshot) => {
                const firebaseGoal = snapshot.val();
                if (firebaseGoal) {
                    localStorage.setItem('monthlyGoal', firebaseGoal);
                    if (currentView === 'dashboard') {
                        renderMonthlyGoalProgress();
                    }
                }
            });
        }

        function updateSyncStatus(status, text) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            const syncDot = syncStatus.querySelector('.sync-dot');
            
            syncStatus.className = `sync-status ${status}`;
            syncDot.className = `sync-dot ${status}`;
            syncText.textContent = text;
        }

        function setCustomSchedule(dayKey, schedule) {
            const customSchedules = JSON.parse(localStorage.getItem('customSchedules') || '{}');
            customSchedules[dayKey] = schedule;
            localStorage.setItem('customSchedules', JSON.stringify(customSchedules));
            
            // Sync to Firebase
            if (isFirebaseInitialized) {
                syncToFirebase('customSchedules', customSchedules);
            }
        }

        function deleteCustomSchedule(dayKey) {
            const customSchedules = JSON.parse(localStorage.getItem('customSchedules') || '{}');
            delete customSchedules[dayKey];
            localStorage.setItem('customSchedules', JSON.stringify(customSchedules));
            
            // Sync to Firebase
            if (isFirebaseInitialized) {
                syncToFirebase('customSchedules', customSchedules);
            }
        }

        function setMonthlyGoal(goal) {
            localStorage.setItem('monthlyGoal', goal);
            
            // Sync to Firebase
            if (isFirebaseInitialized) {
                database.ref('monthlyGoal').set(goal);
            }
        }


        function getDayKey(year, month, day) {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        // Excel Export Function
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const data = getProductionData();
            
            // Arkusz 1: Dane miesięczne
            const monthlyData = [];
            monthlyData.push(['Data', 'Kamil', 'Igor', 'Jarek', 'Wowa', 'SUMA', 'Zmiana Kamil', 'Zmiana Igor', 'Zmiana Jarek', 'Zmiana Wowa']);
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayKey = getDayKey(currentYear, currentMonth, day);
                const dayData = data[dayKey] || {};
                
                const row = [
                    `${day} ${MONTHS[currentMonth]} ${currentYear}`,
                    dayData['Kamil'] || 0,
                    dayData['Igor'] || 0,
                    dayData['Jarek'] || 0,
                    dayData['Wowa'] || 0,
                    (dayData['Kamil'] || 0) + (dayData['Igor'] || 0) + (dayData['Jarek'] || 0) + (dayData['Wowa'] || 0),
                    getShift('Kamil', date),
                    getShift('Igor', date),
                    getShift('Jarek', date),
                    getShift('Wowa', date)
                ];
                monthlyData.push(row);
            }
            
            const ws1 = XLSX.utils.aoa_to_sheet(monthlyData);
            XLSX.utils.book_append_sheet(wb, ws1, "Dane miesięczne");
            
            // Arkusz 2: Zestawienie roczne
            const yearlyData = [];
            yearlyData.push(['Miesiąc', 'Kamil', 'Igor', 'Jarek', 'Wowa', 'SUMA']);
            
            for (let month = 0; month < 12; month++) {
                const monthStats = {};
                WORKERS.forEach(w => monthStats[w] = 0);
                
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayKey = getDayKey(currentYear, month, day);
                    const dayData = data[dayKey] || {};
                    
                    WORKERS.forEach(worker => {
                        if (dayData[worker]) monthStats[worker] += dayData[worker];
                    });
                }
                
                const total = WORKERS.reduce((sum, w) => sum + monthStats[w], 0);
                yearlyData.push([
                    MONTHS[month],
                    monthStats['Kamil'],
                    monthStats['Igor'],
                    monthStats['Jarek'],
                    monthStats['Wowa'],
                    total
                ]);
            }
            
            const ws2 = XLSX.utils.aoa_to_sheet(yearlyData);
            XLSX.utils.book_append_sheet(wb, ws2, "Zestawienie roczne");
            
            // Arkusz 3: Statystyki
            const statsData = [];
            statsData.push(['Statystyka', 'Wartość']);
            
            const monthStats = getMonthStatsForComparison(currentYear, currentMonth);
            statsData.push(['Bieżący miesiąc', `${MONTHS[currentMonth]} ${currentYear}`]);
            statsData.push(['Suma produkcji', monthStats.total || 0]);
            statsData.push(['Średnia dzienna', monthStats.totalAvg || 0]);
            statsData.push(['']);
            
            WORKERS.forEach(worker => {
                const workerStats = monthStats.workers[worker] || { total: 0, avg: 0, days: 0 };
                statsData.push([`${worker} - Suma`, workerStats.total]);
                statsData.push([`${worker} - Średnia`, workerStats.avg]);
                statsData.push([`${worker} - Dni pracy`, workerStats.days]);
                statsData.push(['']);
            });
            
            const ws3 = XLSX.utils.aoa_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, ws3, "Statystyki");
            
            // Zapisz plik
            XLSX.writeFile(wb, `Produkcja_Flexo_${currentYear}_${MONTHS[currentMonth]}.xlsx`);
            showToast('📊 Eksport do Excel zakończony!');
        }

        // Dashboard KPI rendering
        // Monthly Goal Management
        function getMonthlyGoal() {
            const savedGoal = localStorage.getItem('monthlyGoal');
            return savedGoal ? parseInt(savedGoal) : 400000; // Default 400 ton = 400,000 kg
        }

        function setMonthlyGoal(goal) {
            localStorage.setItem('monthlyGoal', goal);
        }

        function openGoalSettings() {
            const currentGoal = getMonthlyGoal();
            const goalInTons = (currentGoal / 1000).toFixed(0);
            
            const newGoalTons = prompt(`Ustaw cel miesięczny w tonach:\n\nAktualny cel: ${goalInTons} ton (${currentGoal.toLocaleString()} kg)`, goalInTons);
            
            if (newGoalTons !== null && newGoalTons !== '') {
                const newGoalKg = parseFloat(newGoalTons) * 1000;
                if (!isNaN(newGoalKg) && newGoalKg > 0) {
                    setMonthlyGoal(newGoalKg);
                    showToast(`🎯 Cel miesięczny ustawiony na ${newGoalTons} ton!`);
                    renderMonthlyGoalProgress();
                } else {
                    alert('Proszę podać prawidłową wartość (większą od 0)');
                }
            }
        }

        function renderMonthlyGoalProgress() {
            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();
            
            // Sprawdź czy to bieżący miesiąc
            if (currentYear !== thisYear || currentMonth !== thisMonth) {
                document.querySelector('.progress-bar-container').style.display = 'none';
                return;
            }
            
            document.querySelector('.progress-bar-container').style.display = 'block';
            
            const goal = getMonthlyGoal();
            const currentStats = getMonthStatsForComparison(thisYear, thisMonth);
            const current = currentStats.total || 0;
            const percentage = goal > 0 ? (current / goal) * 100 : 0;
            
            const currentDay = today.getDate();
            const daysInMonth = new Date(thisYear, thisMonth + 1, 0).getDate();
            const daysRemaining = daysInMonth - currentDay;
            
            // Oblicz ile dni roboczych pozostało
            const data = getProductionData();
            let workingDaysRemaining = 0;
            for (let day = currentDay + 1; day <= daysInMonth; day++) {
                const date = new Date(thisYear, thisMonth, day);
                const dayKey = getDayKey(thisYear, thisMonth, day);
                
                if (isDayHoliday(dayKey)) continue;
                
                let hasWorkingPeople = false;
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    if (shift !== 0) hasWorkingPeople = true;
                });
                if (hasWorkingPeople) workingDaysRemaining += 1;
            }
            
            const remaining = goal - current;
            const neededPerDay = workingDaysRemaining > 0 ? remaining / workingDaysRemaining : 0;
            const avgPerDay = currentStats.daysWithData > 0 ? parseFloat(currentStats.totalAvg) : 0;
            
            // Określ status
            let statusClass = 'neutral';
            let statusIcon = '→';
            let statusText = 'Stabilnie';
            
            if (percentage >= 100) {
                statusClass = 'positive';
                statusIcon = '🎉';
                statusText = 'CEL OSIĄGNIĘTY!';
            } else if (neededPerDay <= avgPerDay) {
                statusClass = 'positive';
                statusIcon = '✅';
                statusText = 'Na czasie - obecne tempo wystarczy!';
            } else if (neededPerDay <= avgPerDay * 1.1) {
                statusClass = 'neutral';
                statusIcon = '⚠️';
                statusText = 'Blisko celu - lekkie przyspieszenie potrzebne';
            } else {
                statusClass = 'negative';
                statusIcon = '🔴';
                statusText = 'Opóźnienie - potrzebne znaczne przyspieszenie!';
            }
            
            // Renderuj info
            const infoHtml = `
                <div style="flex: 1; min-width: 200px;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Cel miesięczny</div>
                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--accent);">${(goal / 1000).toFixed(0)} ton</div>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Dotychczas</div>
                    <div style="font-size: 1.3rem; font-weight: 700;">${(current / 1000).toFixed(1)} ton</div>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Pozostało</div>
                    <div style="font-size: 1.3rem; font-weight: 700;">${(remaining / 1000).toFixed(1)} ton</div>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Dni robocze pozostało</div>
                    <div style="font-size: 1.3rem; font-weight: 700;">${workingDaysRemaining} dni</div>
                </div>
            `;
            
            document.getElementById('monthlyGoalInfo').innerHTML = infoHtml;
            
            // Renderuj progress bar
            const progressFill = document.getElementById('goalProgressFill');
            const cappedPercentage = Math.min(percentage, 100);
            progressFill.style.width = cappedPercentage + '%';
            
            if (percentage >= 100) {
                progressFill.style.background = 'linear-gradient(90deg, #4caf50 0%, #66bb6a 100%)';
                progressFill.textContent = '🎉 ' + percentage.toFixed(1) + '%';
            } else if (percentage >= 80) {
                progressFill.style.background = 'linear-gradient(90deg, #4caf50 0%, #66bb6a 100%)';
                progressFill.textContent = percentage.toFixed(1) + '%';
            } else if (percentage >= 50) {
                progressFill.style.background = 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';
                progressFill.textContent = percentage.toFixed(1) + '%';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #f44336 0%, #ef5350 100%)';
                progressFill.textContent = percentage.toFixed(1) + '%';
            }
            
            // Renderuj status message
            let statusMessageHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div class="kpi-change ${statusClass}" style="margin: 0;">
                        <span>${statusIcon} ${statusText}</span>
                    </div>
            `;
            
            if (percentage < 100 && workingDaysRemaining > 0) {
                const comparisonClass = neededPerDay <= avgPerDay ? 'positive' : 'negative';
                statusMessageHtml += `
                    <div style="text-align: right;">
                        <div style="color: var(--text-secondary); font-size: 0.85rem;">Potrzebne dziennie</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: ${comparisonClass === 'positive' ? 'var(--success)' : 'var(--danger)'};">
                            ${(neededPerDay / 1000).toFixed(1)} ton/dzień
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem;">
                            Obecne tempo: ${(avgPerDay / 1000).toFixed(1)} ton/dzień
                        </div>
                    </div>
                `;
            }
            
            statusMessageHtml += `</div>`;
            
            document.getElementById('goalStatusMessage').innerHTML = statusMessageHtml;
        }

        function renderDashboard() {
            renderMonthlyGoalProgress();
            renderKPIDashboard();
            renderDashboardCharts();
            renderDashboardPodium();
        }

        function renderKPIDashboard() {
            const data = getProductionData();
            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();
            
            // Statystyki dla bieżącego miesiąca
            const currentStats = getMonthStatsForComparison(thisYear, thisMonth);
            
            // Statystyki dla poprzedniego miesiąca
            const prevMonth = thisMonth === 0 ? 11 : thisMonth - 1;
            const prevYear = thisMonth === 0 ? thisYear - 1 : thisYear;
            const prevStats = getMonthStatsForComparison(prevYear, prevMonth);
            
            // Sprawdź czy bieżący miesiąc jest w trakcie
            const isCurrentMonth = true; // zawsze true bo renderKPIDashboard działa tylko dla dashboardu (bieżącego miesiąca)
            const currentDay = today.getDate();
            
            // Dla porównania "dzień do dnia" - oblicz statystyki poprzedniego miesiąca DO tego samego dnia
            let prevMonthSameDayStats = { total: 0, totalAvg: 0, daysWithData: 0 };
            
            if (isCurrentMonth) {
                // Zlicz produkcję z poprzedniego miesiąca do tego samego dnia co dziś
                let totalSoFar = 0;
                let daysWithData = 0;
                
                const prevMonthDaysInMonth = new Date(prevYear, prevMonth + 1, 0).getDate();
                const daysToCompare = Math.min(currentDay, prevMonthDaysInMonth);
                
                for (let day = 1; day <= daysToCompare; day++) {
                    const dayKey = getDayKey(prevYear, prevMonth, day);
                    const dayData = data[dayKey] || {};
                    
                    if (isDayHoliday(dayKey)) {
                        continue;
                    }
                    
                    let hasDayData = false;
                    WORKERS.forEach(worker => {
                        if (dayData[worker] !== undefined) {
                            totalSoFar += dayData[worker];
                            hasDayData = true;
                        }
                    });
                    
                    if (hasDayData) {
                        daysWithData += 1;
                    }
                }
                
                prevMonthSameDayStats.total = totalSoFar;
                prevMonthSameDayStats.daysWithData = daysWithData;
                prevMonthSameDayStats.totalAvg = daysWithData > 0 ? (totalSoFar / daysWithData).toFixed(1) : 0;
            }
            
            const kpis = [
                {
                    icon: '📦',
                    title: 'Produkcja w tym miesiącu',
                    value: currentStats.total ? currentStats.total.toFixed(0) + ' kg' : '0 kg',
                    change: calculateKPIChange(currentStats.total || 0, prevMonthSameDayStats.total || 0),
                    prevValue: `${prevMonthSameDayStats.total.toFixed(0)} kg (do ${currentDay}. dnia)`,
                    compareLabel: 'vs poprz. mies.'
                },
                {
                    icon: '📊',
                    title: 'Średnia dzienna',
                    value: currentStats.totalAvg ? parseFloat(currentStats.totalAvg).toFixed(1) + ' kg' : '0 kg',
                    change: calculateKPIChange(parseFloat(currentStats.totalAvg) || 0, parseFloat(prevStats.totalAvg) || 0),
                    prevValue: prevStats.totalAvg ? parseFloat(prevStats.totalAvg).toFixed(1) + ' kg' : '0 kg',
                    compareLabel: 'vs poprz. mies.'
                },
                {
                    icon: '🔮',
                    title: 'Prognoza na koniec miesiąca',
                    value: getMonthForecast(currentStats),
                    change: null
                },
                {
                    icon: '🎯',
                    title: 'Dni z danymi',
                    value: currentStats.daysWithData || 0,
                    change: null
                }
            ];
            
            let html = '';
            kpis.forEach(kpi => {
                let changeHtml = '';
                if (kpi.change !== null) {
                    const changeClass = kpi.change.percent >= 10 ? 'positive' : 
                                      kpi.change.percent <= -10 ? 'negative' : 'neutral';
                    const icon = kpi.change.percent > 0 ? '↗' : 
                               kpi.change.percent < 0 ? '↘' : '→';
                    
                    changeHtml = `
                        <div class="kpi-change ${changeClass}">
                            <span>${icon}${kpi.change.percent > 0 ? '+' : ''}${kpi.change.percent.toFixed(1)}%</span>
                            <span style="font-size: 0.8rem; opacity: 0.8;">${kpi.compareLabel}: ${kpi.prevValue}</span>
                        </div>
                    `;
                }
                
                html += `
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon">${kpi.icon}</div>
                            <div class="kpi-title">${kpi.title}</div>
                        </div>
                        <div class="kpi-value">${kpi.value}</div>
                        ${changeHtml}
                    </div>
                `;
            });
            
            document.getElementById('kpiDashboard').innerHTML = html;
        }

        function calculateKPIChange(current, previous) {
            if (previous === 0) return { percent: 0, diff: current };
            const diff = current - previous;
            const percent = (diff / previous) * 100;
            return { percent, diff };
        }

        function getMonthForecast(stats) {
            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();
            
            // Sprawdź czy to bieżący miesiąc
            if (currentYear !== thisYear || currentMonth !== thisMonth) {
                return 'Tylko dla bieżącego miesiąca';
            }
            
            const data = getProductionData();
            const currentDay = today.getDate();
            const daysInMonth = new Date(thisYear, thisMonth + 1, 0).getDate();
            
            // Znajdź ostatni dzień z KOMPLETNYMI danymi
            let lastCompleteDay = 0;
            for (let day = 1; day <= currentDay; day++) {
                const date = new Date(thisYear, thisMonth, day);
                const dayKey = getDayKey(thisYear, thisMonth, day);
                const dayData = data[dayKey] || {};
                
                // Sprawdź czy ten dzień ma dane od wszystkich pracowników którzy mieli pracować
                let allWorkersReported = true;
                let anyWorkerShouldWork = false;
                
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    if (shift !== 0) {
                        anyWorkerShouldWork = true;
                        if (dayData[worker] === undefined) {
                            allWorkersReported = false;
                        }
                    }
                });
                
                // Jeśli ktoś miał pracować i wszyscy raportowali - dzień kompletny
                if (anyWorkerShouldWork && allWorkersReported) {
                    lastCompleteDay = day;
                }
            }
            
            // Jeśli nie ma żadnego kompletnego dnia, użyj wszystkich dostępnych danych
            if (lastCompleteDay === 0) {
                lastCompleteDay = currentDay;
            }
            
            // Oblicz sumę dotychczasową DO ostatniego kompletnego dnia
            let totalSoFar = 0;
            let daysWithDataSoFar = 0;
            
            for (let day = 1; day <= lastCompleteDay; day++) {
                const dayKey = getDayKey(thisYear, thisMonth, day);
                const dayData = data[dayKey] || {};
                
                let hasDayData = false;
                WORKERS.forEach(worker => {
                    if (dayData[worker] !== undefined) {
                        totalSoFar += dayData[worker];
                        hasDayData = true;
                    }
                });
                
                if (hasDayData) {
                    daysWithDataSoFar += 1;
                }
            }
            
            if (daysWithDataSoFar === 0) {
                return 'Brak danych';
            }
            
            const avgPerDay = totalSoFar / daysWithDataSoFar;
            
            // Szacuj pozostałe dni robocze (od lastCompleteDay + 1)
            let estimatedRemainingDays = 0;
            for (let day = lastCompleteDay + 1; day <= daysInMonth; day++) {
                const date = new Date(thisYear, thisMonth, day);
                const dayKey = getDayKey(thisYear, thisMonth, day);
                
                if (isDayHoliday(dayKey)) continue;
                
                let hasWorkingPeople = false;
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    if (shift !== 0) hasWorkingPeople = true;
                });
                if (hasWorkingPeople) estimatedRemainingDays += 1;
            }
            
            const forecastTotal = totalSoFar + (avgPerDay * estimatedRemainingDays);
            
            return forecastTotal.toFixed(0) + ' kg';
        }

        function renderDashboardCharts() {
            const ctx1 = document.getElementById('dashboardTrendChart');
            if (!ctx1) return;
            
            if (dashboardTrendChart) {
                dashboardTrendChart.destroy();
            }
            
            // Trend ostatnich 3 miesięcy
            const today = new Date();
            const months = [];
            const totals = [];
            
            for (let i = 2; i >= 0; i--) {
                const month = today.getMonth() - i;
                const year = month < 0 ? today.getFullYear() - 1 : today.getFullYear();
                const adjustedMonth = month < 0 ? 12 + month : month;
                
                const stats = getMonthStatsForComparison(year, adjustedMonth);
                months.push(MONTHS[adjustedMonth]);
                totals.push(stats.total || 0);
            }
            
            dashboardTrendChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Produkcja (kg)',
                        data: totals,
                        borderColor: 'rgb(255, 107, 53)',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgb(255, 107, 53)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(0) + ' kg';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#b0b0b0',
                                callback: function(value) {
                                    return value + ' kg';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b0b0b0' }
                        }
                    }
                }
            });
            
            // Performance comparison
            const ctx2 = document.getElementById('dashboardPerformanceChart');
            if (!ctx2) return;
            
            if (dashboardPerformanceChart) {
                dashboardPerformanceChart.destroy();
            }
            
            const currentStats = getMonthStatsForComparison(today.getFullYear(), today.getMonth());
            const workerAvgs = WORKERS.map(w => {
                const stats = currentStats.workers[w];
                return stats && stats.days >= 3 ? parseFloat(stats.avg) : 0;
            });
            
            dashboardPerformanceChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: WORKERS,
                    datasets: [{
                        label: 'Średnia dzienna (kg)',
                        data: workerAvgs,
                        backgroundColor: [
                            'rgba(123, 237, 159, 0.8)',
                            'rgba(255, 165, 2, 0.8)',
                            'rgba(112, 161, 255, 0.8)',
                            'rgba(255, 99, 72, 0.8)'
                        ],
                        borderColor: [
                            'rgb(46, 213, 115)',
                            'rgb(255, 127, 0)',
                            'rgb(30, 144, 255)',
                            'rgb(255, 71, 87)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(1) + ' kg/dzień';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#b0b0b0',
                                callback: function(value) {
                                    return value + ' kg';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#b0b0b0',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function renderDashboardPodium() {
            const today = new Date();
            const currentStats = getMonthStatsForComparison(today.getFullYear(), today.getMonth());
            const prevMonth = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
            const prevYear = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
            const prevStats = getMonthStatsForComparison(prevYear, prevMonth);
            
            const sortedWorkers = WORKERS.map(worker => {
                const stats = currentStats.workers[worker] || { total: 0, avg: 0, days: 0 };
                const prevWorkerStats = prevStats.workers[worker] || { avg: 0 };
                
                return {
                    name: worker,
                    total: stats.total,
                    avg: parseFloat(stats.avg),
                    days: stats.days,
                    prevAvg: parseFloat(prevWorkerStats.avg)
                };
            }).sort((a, b) => b.total - a.total);
            
            const medals = ['🥇', '🥈', '🥉', ''];
            let html = '';
            
            sortedWorkers.forEach((worker, index) => {
                const rank = index + 1;
                
                let workerComparisonHtml = '';
                if (worker.days >= 3 && worker.prevAvg > 0) {
                    const comparison = calculateComparison(worker.avg, worker.prevAvg);
                    workerComparisonHtml = `<div class="podium-label comparison-text ${comparison.class}">Poprz. mies.: ${worker.prevAvg.toFixed(1)} kg/dzień ${comparison.icon} ${comparison.text}</div>`;
                } else if (worker.days >= 3) {
                    workerComparisonHtml = `<div class="podium-label comparison-text">Poprz. mies.: brak danych</div>`;
                }
                
                html += `
                    <div class="podium-card rank-${rank} ${worker.name.toLowerCase()}">
                        <div class="podium-rank">${medals[index]}</div>
                        <div class="podium-name">${worker.name}</div>
                        <div class="podium-value">${worker.total.toFixed(0)} kg</div>
                        <div class="podium-label">Średnia: ${worker.avg.toFixed(1)} kg/dzień • ${worker.days} dni</div>
                        ${workerComparisonHtml}
                    </div>
                `;
            });
            
            document.getElementById('dashboardPodium').innerHTML = html;
        }

        // Analytics View
        function renderAnalytics() {
            renderAnalysisCards();
            renderAnalyticsCharts();
        }

        function renderAnalysisCards() {
            const data = getProductionData();
            const today = new Date();
            
            // Analiza efektywności według zmian
            const shiftStats = {
                1: { total: 0, count: 0 },
                2: { total: 0, count: 0 },
                3: { total: 0, count: 0 }
            };
            
            // Zbierz dane dla zmian
            Object.keys(data).forEach(dayKey => {
                const [year, month, day] = dayKey.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const dayData = data[dayKey];
                
                WORKERS.forEach(worker => {
                    if (dayData[worker]) {
                        const shift = getShiftForDay(worker, date);
                        if (shift > 0) {
                            shiftStats[shift].total += dayData[worker];
                            shiftStats[shift].count += 1;
                        }
                    }
                });
            });
            
            // Oblicz średnie dla zmian
            const shiftAvgs = {};
            [1, 2, 3].forEach(shift => {
                shiftAvgs[shift] = shiftStats[shift].count > 0 ? 
                    (shiftStats[shift].total / shiftStats[shift].count).toFixed(1) : 0;
            });
            
            // Momentum produkcji (ostatnie 7 dni vs poprzednie 7 dni)
            const momentumData = calculateMomentum();
            
            const cards = [
                {
                    title: '🌅 Efektywność według zmian',
                    items: [
                        { label: 'Rano (6-14)', value: `${shiftAvgs[1]} kg/dzień` },
                        { label: 'Popołudnie (14-22)', value: `${shiftAvgs[2]} kg/dzień` },
                        { label: 'Noc (22-6)', value: `${shiftAvgs[3]} kg/dzień` }
                    ]
                },
                {
                    title: '📈 Momentum produkcji (trend 7vs7 dni)',
                    items: momentumData.items
                },
                {
                    title: '📊 Trendy roczne',
                    items: calculateYearlyTrends()
                }
            ];
            
            let html = '';
            cards.forEach(card => {
                html += `
                    <div class="analysis-card">
                        <div class="analysis-title">${card.title}</div>
                `;
                
                card.items.forEach(item => {
                    html += `
                        <div class="analysis-item">
                            <span class="analysis-label">${item.label}</span>
                            <span class="analysis-value">${item.value}</span>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            document.getElementById('analysisCards').innerHTML = html;
        }

        function calculateYearlyTrends() {
            const data = getProductionData();
            const today = new Date();
            const monthlyTotals = {};
            
            for (let i = 0; i < 12; i++) {
                monthlyTotals[i] = 0;
            }
            
            Object.keys(data).forEach(dayKey => {
                const [year, month, day] = dayKey.split('-').map(Number);
                if (year === currentYear) {
                    const dayData = data[dayKey];
                    WORKERS.forEach(worker => {
                        if (dayData[worker]) {
                            monthlyTotals[month - 1] += dayData[worker];
                        }
                    });
                }
            });
            
            // Zlicz tylko pełne miesiące (pomijamy bieżący miesiąc jeśli nie jest zakończony)
            let fullMonthsCount = 0;
            let fullMonthsTotal = 0;
            let maxValue = 0;
            let minValue = Infinity;
            let maxMonth = null;
            let minMonth = null;
            
            for (let month = 0; month < 12; month++) {
                const isCurrentMonth = (month === today.getMonth() && currentYear === today.getFullYear());
                const lastDayOfMonth = new Date(currentYear, month + 1, 0).getDate();
                const isFullMonth = !isCurrentMonth || today.getDate() >= lastDayOfMonth;
                
                // Tylko pełne miesiące z produkcją
                if (monthlyTotals[month] > 0 && isFullMonth) {
                    fullMonthsCount++;
                    fullMonthsTotal += monthlyTotals[month];
                    
                    // Szukaj max i min tylko w pełnych miesiącach
                    if (monthlyTotals[month] > maxValue) {
                        maxValue = monthlyTotals[month];
                        maxMonth = month;
                    }
                    if (monthlyTotals[month] < minValue) {
                        minValue = monthlyTotals[month];
                        minMonth = month;
                    }
                }
            }
            
            if (fullMonthsCount === 0) {
                return [{ label: 'Brak danych', value: '-' }];
            }
            
            const avg = fullMonthsTotal / fullMonthsCount;
            const isCurrentYearIncomplete = currentYear === today.getFullYear() && today.getMonth() < 11;
            const currentMonthName = MONTHS[today.getMonth()];
            
            const items = [
                { 
                    label: 'Średnia miesięczna', 
                    value: `${avg.toFixed(0)} kg (${fullMonthsCount} ${fullMonthsCount === 1 ? 'miesiąc' : 'miesięcy'})` 
                },
                { 
                    label: 'Najlepszy miesiąc', 
                    value: maxMonth !== null ? `${MONTHS[maxMonth]} (${maxValue.toFixed(0)} kg)` : '-' 
                },
                { 
                    label: 'Najsłabszy miesiąc', 
                    value: minMonth !== null ? `${MONTHS[minMonth]} (${minValue.toFixed(0)} kg)` : '-' 
                }
            ];
            
            // Dodaj info o bieżącym miesiącu jeśli jest w trakcie
            if (isCurrentYearIncomplete && fullMonthsCount < 12) {
                items.push({
                    label: '📌 Uwaga',
                    value: `${currentMonthName} w trakcie - nie liczony`
                });
            }
            
            return items;
        }

        function calculateMomentum() {
            const data = getProductionData();
            const today = new Date();
            
            // Zbierz dane z ostatnich 14 dni (NIE licząc dzisiejszego dnia)
            const last7Days = [];
            const previous7Days = [];
            
            // Ostatnie 7 dni = wczoraj i 6 dni wstecz (dni 1-7 wstecz od dzisiaj)
            for (let i = 1; i <= 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dayKey = getDayKey(date.getFullYear(), date.getMonth(), date.getDate());
                const dayData = data[dayKey] || {};
                
                let dayTotal = 0;
                WORKERS.forEach(worker => {
                    if (dayData[worker]) {
                        dayTotal += dayData[worker];
                    }
                });
                
                last7Days.push(dayTotal);
            }
            
            // Poprzednie 7 dni = 8-14 dni wstecz od dzisiaj
            for (let i = 8; i <= 14; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dayKey = getDayKey(date.getFullYear(), date.getMonth(), date.getDate());
                const dayData = data[dayKey] || {};
                
                let dayTotal = 0;
                WORKERS.forEach(worker => {
                    if (dayData[worker]) {
                        dayTotal += dayData[worker];
                    }
                });
                
                previous7Days.push(dayTotal);
            }
            
            const last7Total = last7Days.reduce((a, b) => a + b, 0);
            const previous7Total = previous7Days.reduce((a, b) => a + b, 0);
            
            const last7Avg = last7Days.length > 0 ? last7Total / 7 : 0;
            const previous7Avg = previous7Days.length > 0 ? previous7Total / 7 : 0;
            
            let trend = '';
            let trendIcon = '';
            let trendClass = '';
            let changePercent = 0;
            
            if (previous7Avg > 0) {
                changePercent = ((last7Avg - previous7Avg) / previous7Avg * 100);
                
                if (changePercent >= 10) {
                    trend = 'ROSNĄCY ↗️';
                    trendIcon = '🔥';
                    trendClass = 'trend-up';
                } else if (changePercent <= -10) {
                    trend = 'SPADAJĄCY ↘️';
                    trendIcon = '⚠️';
                    trendClass = 'trend-down';
                } else if (changePercent > 0) {
                    trend = 'STABILNY (lekki wzrost) →';
                    trendIcon = '✅';
                    trendClass = 'trend-stable';
                } else if (changePercent < 0) {
                    trend = 'STABILNY (lekki spadek) →';
                    trendIcon = '⚠️';
                    trendClass = 'trend-stable';
                } else {
                    trend = 'BEZ ZMIAN →';
                    trendIcon = '➡️';
                    trendClass = 'trend-stable';
                }
            } else {
                trend = 'Brak danych z poprzedniego okresu';
                trendIcon = '❓';
                trendClass = '';
            }
            
            const items = [
                { label: 'Ostatnie 7 dni (średnia)', value: `${last7Avg.toFixed(0)} kg/dzień` },
                { label: 'Poprzednie 7 dni (średnia)', value: `${previous7Avg.toFixed(0)} kg/dzień` },
                { label: 'Zmiana', value: previous7Avg > 0 ? `${changePercent > 0 ? '+' : ''}${changePercent.toFixed(1)}%` : '-' },
                { label: `${trendIcon} Trend`, value: trend }
            ];
            
            return { items, trendClass };
        }

        function renderAnalyticsCharts() {
            renderShiftEfficiencyChart();
            renderYoYGrowthChart();
            renderAverageRankingChart();
            renderDistributionChart();
        }

        function renderShiftEfficiencyChart() {
            const ctx = document.getElementById('shiftEfficiencyChart');
            if (!ctx) return;
            
            if (shiftEfficiencyChart) {
                shiftEfficiencyChart.destroy();
            }
            
            const data = getProductionData();
            const shiftStats = {
                1: { total: 0, count: 0 },
                2: { total: 0, count: 0 },
                3: { total: 0, count: 0 }
            };
            
            Object.keys(data).forEach(dayKey => {
                const [year, month, day] = dayKey.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const dayData = data[dayKey];
                
                WORKERS.forEach(worker => {
                    if (dayData[worker]) {
                        const shift = getShiftForDay(worker, date);
                        if (shift > 0) {
                            shiftStats[shift].total += dayData[worker];
                            shiftStats[shift].count += 1;
                        }
                    }
                });
            });
            
            const avgs = [1, 2, 3].map(shift => 
                shiftStats[shift].count > 0 ? shiftStats[shift].total / shiftStats[shift].count : 0
            );
            
            shiftEfficiencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Rano (6-14)', 'Popołudnie (14-22)', 'Noc (22-6)'],
                    datasets: [{
                        label: 'Średnia produkcja (kg)',
                        data: avgs,
                        backgroundColor: [
                            'rgba(255, 215, 0, 0.8)',
                            'rgba(255, 107, 53, 0.8)',
                            'rgba(155, 89, 182, 0.8)'
                        ],
                        borderColor: [
                            'rgb(255, 215, 0)',
                            'rgb(255, 107, 53)',
                            'rgb(155, 89, 182)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(1) + ' kg';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#b0b0b0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b0b0b0' }
                        }
                    }
                }
            });
        }

        function renderYoYGrowthChart() {
            const ctx = document.getElementById('yoyGrowthChart');
            if (!ctx) return;
            
            if (yoyGrowthChart) {
                yoyGrowthChart.destroy();
            }
            
            // Porównanie roku do roku dla każdego miesiąca
            const data = getProductionData();
            const years = [currentYear - 1, currentYear];
            const datasets = [];
            
            years.forEach((year, idx) => {
                const monthlyData = [];
                for (let month = 0; month < 12; month++) {
                    const stats = getMonthStatsForComparison(year, month);
                    monthlyData.push(stats.total || 0);
                }
                
                datasets.push({
                    label: year.toString(),
                    data: monthlyData,
                    borderColor: idx === 0 ? 'rgba(176, 176, 176, 0.8)' : 'rgba(255, 107, 53, 0.8)',
                    backgroundColor: idx === 0 ? 'rgba(176, 176, 176, 0.1)' : 'rgba(255, 107, 53, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true
                });
            });
            
            yoyGrowthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: MONTHS,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#b0b0b0' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' kg';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#b0b0b0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b0b0b0' }
                        }
                    }
                }
            });
        }

        function renderAverageRankingChart() {
            const ctx = document.getElementById('averageRankingChart');
            if (!ctx) return;
            
            if (averageRankingChart) {
                averageRankingChart.destroy();
            }
            
            const data = getProductionData();
            const today = new Date();
            const workerStats = {};
            
            WORKERS.forEach(worker => {
                workerStats[worker] = {
                    total: 0,
                    days: 0
                };
            });
            
            // Przechodzimy przez wszystkie dni w bazie danych (tylko te które faktycznie miały miejsce)
            Object.keys(data).forEach(dayKey => {
                const [year, month, day] = dayKey.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                
                // Pomijamy przyszłe dni
                if (date > today) return;
                
                const dayData = data[dayKey];
                
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    
                    // Jeśli pracownik miał zmianę tego dnia (nie wolne)
                    if (shift !== 0) {
                        // Sprawdź czy jest wpis dla tego pracownika
                        if (dayData[worker] !== undefined) {
                            workerStats[worker].days += 1;
                            workerStats[worker].total += dayData[worker]; // może być 0 lub wartość
                        }
                    }
                });
            });
            
            // Oblicz średnie
            const workerAvgs = {};
            WORKERS.forEach(worker => {
                workerAvgs[worker] = workerStats[worker].days > 0 ?
                    workerStats[worker].total / workerStats[worker].days : 0;
            });
            
            const sorted = WORKERS.map(w => ({
                name: w,
                avg: workerAvgs[w],
                days: workerStats[w].days
            })).sort((a, b) => b.avg - a.avg);
            
            // Mapowanie kolorów według nazwy pracownika, nie według pozycji w rankingu
            const getWorkerColors = (workerName) => {
                const colorMap = {
                    'Kamil': {
                        bg: 'rgba(123, 237, 159, 0.8)',
                        border: 'rgb(46, 213, 115)'
                    },
                    'Igor': {
                        bg: 'rgba(255, 165, 2, 0.8)',
                        border: 'rgb(255, 127, 0)'
                    },
                    'Jarek': {
                        bg: 'rgba(112, 161, 255, 0.8)',
                        border: 'rgb(30, 144, 255)'
                    },
                    'Wowa': {
                        bg: 'rgba(255, 99, 72, 0.8)',
                        border: 'rgb(255, 71, 87)'
                    }
                };
                return colorMap[workerName] || { bg: 'rgba(100, 100, 100, 0.8)', border: 'rgb(100, 100, 100)' };
            };
            
            averageRankingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(w => w.name),
                    datasets: [{
                        label: 'Średnia ogólna (kg/dzień)',
                        data: sorted.map(w => w.avg),
                        backgroundColor: sorted.map(w => getWorkerColors(w.name).bg),
                        borderColor: sorted.map(w => getWorkerColors(w.name).border),
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const workerData = sorted[context.dataIndex];
                                    return [
                                        context.parsed.x.toFixed(1) + ' kg/dzień',
                                        'Dni robocze: ' + workerData.days
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#b0b0b0' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { 
                                color: '#b0b0b0',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function renderDistributionChart() {
            const ctx = document.getElementById('distributionChart');
            if (!ctx) return;
            
            if (distributionChart) {
                distributionChart.destroy();
            }
            
            // Zbierz dane z całego roku
            const data = getProductionData();
            const yearlyTotals = {};
            
            WORKERS.forEach(worker => {
                yearlyTotals[worker] = 0;
            });
            
            // Sumuj wszystkie dane z bieżącego roku
            Object.keys(data).forEach(dayKey => {
                const [year, month, day] = dayKey.split('-').map(Number);
                if (year === currentYear) {
                    const dayData = data[dayKey];
                    WORKERS.forEach(worker => {
                        if (dayData[worker]) {
                            yearlyTotals[worker] += dayData[worker];
                        }
                    });
                }
            });
            
            const totals = WORKERS.map(w => yearlyTotals[w]);
            
            distributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: WORKERS,
                    datasets: [{
                        data: totals,
                        backgroundColor: [
                            'rgba(123, 237, 159, 0.8)',
                            'rgba(255, 165, 2, 0.8)',
                            'rgba(112, 161, 255, 0.8)',
                            'rgba(255, 99, 72, 0.8)'
                        ],
                        borderColor: [
                            'rgb(46, 213, 115)',
                            'rgb(255, 127, 0)',
                            'rgb(30, 144, 255)',
                            'rgb(255, 71, 87)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                color: '#b0b0b0',
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percent = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return context.label + ': ' + context.parsed.toFixed(0) + ' kg (' + percent + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Pozostałe funkcje z oryginalnego kodu (renderCalendar, modals, etc.)
        // ... (cały pozostały kod z oryginalnego pliku)
        
        function renderCalendar() {
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const data = getProductionData();
            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
            const todayDay = today.getDate();
            
            let daysWithFullData = 0;
            let daysWithMissingData = 0;
            
            for (let day = 1; day <= (isCurrentMonth ? todayDay : daysInMonth); day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayKey = getDayKey(currentYear, currentMonth, day);
                const dayData = data[dayKey] || {};
                
                let workingCount = 0;
                let dataCount = 0;
                
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    if (shift !== 0) {
                        workingCount++;
                        if (dayData[worker] !== undefined) {
                            dataCount++;
                        }
                    }
                });
                
                if (workingCount > 0) {
                    if (dataCount === workingCount) {
                        daysWithFullData++;
                    } else if (dataCount > 0) {
                        daysWithMissingData++;
                    }
                }
            }
            
            let totalRelevantDays = 0;
            for (let day = 1; day <= (isCurrentMonth ? todayDay : daysInMonth); day++) {
                const dayKey = getDayKey(currentYear, currentMonth, day);
                if (!isDayHoliday(dayKey)) {
                    totalRelevantDays++;
                }
            }
            
            const filledDays = daysWithFullData + daysWithMissingData;
            const percentage = totalRelevantDays > 0 ? (filledDays / totalRelevantDays) * 100 : 0;
            
            const progressHtml = `
                <div class="progress-bar-title">
                    📈 Postęp wypełniania: ${filledDays}/${totalRelevantDays} dni
                    ${daysWithFullData > 0 ? `<span class="day-complete">✅ ${daysWithFullData} kompletnych</span>` : ''}
                    ${daysWithMissingData > 0 ? `<span class="day-incomplete">❗ ${daysWithMissingData} niekompletnych</span>` : ''}
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percentage}%">
                        ${percentage > 15 ? Math.round(percentage) + '%' : ''}
                    </div>
                </div>
            `;
            document.getElementById('progressBar').innerHTML = progressHtml;
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Dzień</th>
                            <th style="background: rgba(123, 237, 159, 0.2);">Kamil</th>
                            <th style="background: rgba(255, 165, 2, 0.2);">Igor</th>
                            <th style="background: rgba(112, 161, 255, 0.2);">Jarek</th>
                            <th style="background: rgba(255, 99, 72, 0.2);">Wowa</th>
                            <th style="background: rgba(255, 215, 0, 0.3); border-left: 2px solid rgba(255, 215, 0, 0.6);">SUMA</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayKey = getDayKey(currentYear, currentMonth, day);
                const dayData = data[dayKey] || {};
                
                const dayNames = ['N', 'Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'So'];
                const dayName = dayNames[date.getDay()];
                
                const isTodayRow = isCurrentMonth && day === todayDay ? 'today-row' : '';
                const hasCustomSchedule = getCustomSchedule(dayKey) !== null;
                
                let workingCount = 0;
                let dataCount = 0;
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    if (shift !== 0) {
                        workingCount++;
                        if (dayData[worker] !== undefined) dataCount++;
                    }
                });
                
                let dayIndicator = '';
                const isPast = date < today || (isCurrentMonth && day <= todayDay);
                
                if (workingCount > 0 && isPast && !isDayHoliday(dayKey)) {
                    if (dataCount === workingCount) {
                        dayIndicator = ' <span class="day-indicator day-complete">✅</span>';
                    } else if (dataCount > 0) {
                        dayIndicator = ' <span class="day-indicator day-incomplete">❗</span>';
                    } else if (dataCount === 0) {
                        dayIndicator = ' <span class="day-indicator day-incomplete">❌</span>';
                    }
                }
                
                if (isDayHoliday(dayKey)) {
                    dayIndicator = ' <span class="day-indicator" style="color: #f44336;">🔴</span>';
                }
                
                if (hasCustomSchedule) {
                    dayIndicator += ' <span class="custom-schedule-indicator">⚙️</span>';
                }
                
                let dayTotal = 0;
                WORKERS.forEach(worker => {
                    if (dayData[worker] !== undefined) {
                        dayTotal += dayData[worker];
                    }
                });
                
                html += `<tr class="${isTodayRow}" onclick="openProductionModal(${day})">`;
                html += `<td class="day-cell">${day}${dayIndicator}<br>${dayName}</td>`;
                
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    const value = dayData[worker] !== undefined ? dayData[worker] : '';
                    const shiftClass = shift === 0 ? 'shift-free' : `shift-${shift}`;
                    const shiftText = shift === 1 ? '☀️' : shift === 2 ? '🌆' : shift === 3 ? '🌙' : '💤';
                    
                    const cellClass = shift === 0 ? 'free-day-cell' : `${worker.toLowerCase()}-cell`;
                    
                    html += `<td class="${cellClass}">
                        <div class="${shiftClass}">${shiftText}</div>
                        <div class="production-value">${value !== '' ? value + ' kg' : '-'}</div>
                    </td>`;
                });
                
                html += `<td class="sum-cell">
                    ${dayTotal > 0 ? '<strong>' + dayTotal.toFixed(0) + ' kg</strong>' : '-'}
                </td>`;
                html += `</tr>`;
            }

            html += `</tbody></table>`;
            document.getElementById('calendarTable').innerHTML = html;
            document.getElementById('monthDisplay').textContent = `${MONTHS[currentMonth]} ${currentYear}`;
            
            renderMonthlyStats();
            renderCharts();
            renderForecast();
        }

        function openProductionModal(day) {
            selectedDay = day;
            editMode = false;
            renderProductionModal();
        }

        function renderProductionModal() {
            const date = new Date(currentYear, currentMonth, selectedDay);
            const dayKey = getDayKey(currentYear, currentMonth, selectedDay);
            const data = getProductionData();
            const dayData = data[dayKey] || {};
            const isHoliday = isDayHoliday(dayKey);
            
            const modalTitle = `
                <span>📝 Produkcja - ${selectedDay} ${MONTHS[currentMonth]} ${currentYear}</span>
                <button class="edit-schedule-btn ${editMode ? 'active' : ''}" onclick="toggleEditMode()">
                    ⚙️ Edytuj harmonogram
                </button>
            `;
            document.getElementById('modalTitle').innerHTML = modalTitle;
            
            let html = '';
            
            if (editMode) {
                html += `
                    <div class="schedule-editor">
                        <div class="schedule-editor-title">⚙️ Edytor harmonogramu</div>
                        
                        <div class="holiday-checkbox ${isHoliday ? 'active' : ''}">
                            <input type="checkbox" id="holidayCheckbox" ${isHoliday ? 'checked' : ''} 
                                   onchange="updateHolidayStatus()">
                            <label for="holidayCheckbox">🎄 Dzień wolny od pracy (święto) - wyłącz z obliczeń</label>
                        </div>
                        
                        ${isHoliday ? '<p style="color: var(--text-secondary); margin-bottom: 1rem;">Święto - harmonogram nieaktywny</p>' : ''}
                        
                        <div id="scheduleItems">
                `;
                
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    const isWorking = shift !== 0;
                    
                    html += `
                        <div class="worker-schedule-item">
                            <input type="checkbox" class="worker-checkbox" id="checkbox-${worker}" 
                                   ${isWorking ? 'checked' : ''} ${isHoliday ? 'disabled' : ''}
                                   onchange="toggleWorker('${worker}')">
                            <div class="worker-schedule-name ${worker.toLowerCase()}-label" style="flex: 0 0 120px;">${worker}</div>
                            <select class="shift-selector" id="shift-${worker}" ${!isWorking || isHoliday ? 'disabled' : ''}>
                                <option value="1" ${shift === 1 ? 'selected' : ''}>☀️ Rano (6-14)</option>
                                <option value="2" ${shift === 2 ? 'selected' : ''}>🌆 Popołudnie (14-22)</option>
                                <option value="3" ${shift === 3 ? 'selected' : ''}>🌙 Noc (22-6)</option>
                            </select>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <button class="btn" style="width: 100%; margin-bottom: 0.5rem;" onclick="saveSchedule()">
                            ⚙️ Zapisz harmonogram
                        </button>
                        <button class="reset-schedule-btn" onclick="resetScheduleToDefault()">
                            🔄 Przywróć domyślny harmonogram
                        </button>
                    </div>
                `;
            }
            
            WORKERS.forEach(worker => {
                const shift = getShiftForDay(worker, date);
                const shiftText = shift === 1 ? '☀️ Rano (6-14)' : 
                                 shift === 2 ? '🌆 Popołudnie (14-22)' : 
                                 shift === 3 ? '🌙 Noc (22-6)' : '💤 Wolne';
                const value = dayData[worker] !== undefined ? dayData[worker] : '';
                
                if (shift === 0 && !editMode) {
                    return;
                }
                
                html += `
                    <div class="worker-input" ${shift === 0 ? 'style="opacity: 0.5;"' : ''}>
                        <div class="worker-label ${worker.toLowerCase()}-label">${worker}</div>
                        <div class="shift-indicator">${shiftText}</div>
                    </div>
                    <div class="form-group">
                        <input type="number" id="input-${worker}" value="${value}" 
                               placeholder="Wpisz kg" ${shift === 0 || isHoliday ? 'disabled' : ''} 
                               min="0" step="0.1" onkeydown="handleModalKeydown(event)">
                    </div>
                `;
            });
            
            document.getElementById('modalBody').innerHTML = html;
            
            let buttonsHtml = '';
            if (editMode) {
                buttonsHtml = `
                    <button class="btn" onclick="saveProductionOnly()">💾 Zapisz produkcję</button>
                    <button class="btn btn-secondary" onclick="closeModal()">❌ Anuluj</button>
                `;
            } else {
                buttonsHtml = `
                    <button class="btn" onclick="saveProductionOnly()">💾 Zapisz</button>
                    <button class="btn btn-secondary" onclick="closeModal()">❌ Anuluj</button>
                `;
            }
            document.getElementById('modalButtons').innerHTML = buttonsHtml;
            
            document.getElementById('productionModal').classList.add('active');
            
            if (!editMode) {
                setTimeout(() => {
                    const firstInput = document.querySelector('#modalBody input:not([disabled])');
                    if (firstInput) firstInput.focus();
                }, 100);
            }
        }

        function toggleEditMode() {
            editMode = !editMode;
            renderProductionModal();
        }

        function toggleWorker(worker) {
            const checkbox = document.getElementById(`checkbox-${worker}`);
            const shiftSelector = document.getElementById(`shift-${worker}`);
            shiftSelector.disabled = !checkbox.checked;
        }

        function updateHolidayStatus() {
            const isHoliday = document.getElementById('holidayCheckbox').checked;
            
            WORKERS.forEach(worker => {
                const checkbox = document.getElementById(`checkbox-${worker}`);
                const shiftSelector = document.getElementById(`shift-${worker}`);
                if (checkbox) checkbox.disabled = isHoliday;
                if (shiftSelector) shiftSelector.disabled = isHoliday;
            });
        }

        function saveSchedule() {
            if (!selectedDay) return;
            
            const dayKey = getDayKey(currentYear, currentMonth, selectedDay);
            const isHoliday = document.getElementById('holidayCheckbox').checked;
            
            const schedule = {
                isHoliday: isHoliday,
                workers: {}
            };
            
            if (!isHoliday) {
                WORKERS.forEach(worker => {
                    const checkbox = document.getElementById(`checkbox-${worker}`);
                    const shiftSelector = document.getElementById(`shift-${worker}`);
                    
                    if (checkbox && checkbox.checked && shiftSelector) {
                        schedule.workers[worker] = parseInt(shiftSelector.value);
                    } else {
                        schedule.workers[worker] = 0;
                    }
                });
            } else {
                WORKERS.forEach(worker => {
                    schedule.workers[worker] = 0;
                });
            }
            
            setCustomSchedule(dayKey, schedule);
            showToast('⚙️ Harmonogram zapisany!');
            renderProductionModal();
            renderCalendar();
        }

        function resetScheduleToDefault() {
            if (!selectedDay) return;
            
            if (confirm('Czy na pewno chcesz przywrócić domyślny harmonogram dla tego dnia?')) {
                const dayKey = getDayKey(currentYear, currentMonth, selectedDay);
                deleteCustomSchedule(dayKey);
                showToast('🔄 Przywrócono domyślny harmonogram!');
                renderProductionModal();
                renderCalendar();
            }
        }

        function handleModalKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveProductionOnly();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                closeModal();
            } else if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();
                const inputs = Array.from(document.querySelectorAll('#modalBody input:not([disabled])'));
                const currentIndex = inputs.indexOf(event.target);
                
                if (event.key === 'ArrowUp' && currentIndex > 0) {
                    inputs[currentIndex - 1].focus();
                } else if (event.key === 'ArrowDown' && currentIndex < inputs.length - 1) {
                    inputs[currentIndex + 1].focus();
                }
            } else if (event.key === 'ArrowLeft') {
                event.preventDefault();
                navigateDay(-1);
            } else if (event.key === 'ArrowRight') {
                event.preventDefault();
                navigateDay(1);
            }
        }

        function navigateDay(delta) {
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            let newDay = selectedDay + delta;
            
            if (newDay < 1) {
                changeMonth(-1);
                const prevMonthDays = new Date(currentYear, currentMonth + 1, 0).getDate();
                newDay = prevMonthDays;
            } else if (newDay > daysInMonth) {
                changeMonth(1);
                newDay = 1;
            }
            
            closeModal();
            setTimeout(() => openProductionModal(newDay), 100);
        }

        function saveProductionOnly() {
            if (!selectedDay) return;
            
            const dayKey = getDayKey(currentYear, currentMonth, selectedDay);
            const data = getProductionData();
            
            if (!data[dayKey]) {
                data[dayKey] = {};
            }
            
            WORKERS.forEach(worker => {
                const input = document.getElementById(`input-${worker}`);
                if (input && !input.disabled) {
                    const value = parseFloat(input.value);
                    if (!isNaN(value) && value >= 0) {
                        data[dayKey][worker] = value;
                    } else if (input.value === '') {
                        delete data[dayKey][worker];
                    }
                }
            });
            
            if (Object.keys(data[dayKey]).length === 0) {
                delete data[dayKey];
            }
            
            setProductionData(data);
            showToast('✅ Produkcja zapisana!');
            closeModal();
            
            // Odśwież aktualny widok
            if (currentView === 'dashboard') {
                renderDashboard();
            } else if (currentView === 'monthly') {
                renderCalendar();
            } else if (currentView === 'yearly') {
                renderYearlyStats();
            } else if (currentView === 'analytics') {
                renderAnalytics();
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast';
            setTimeout(() => {
                toast.className = '';
            }, 3000);
        }

        function closeModal() {
            document.getElementById('productionModal').classList.remove('active');
            selectedDay = null;
            editMode = false;
        }

        function renderMonthlyStats() {
            const data = getProductionData();
            const stats = {};
            let totalSum = 0;
            let daysWithData = 0;
            
            WORKERS.forEach(worker => {
                stats[worker] = { total: 0, days: 0 };
            });
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayKey = getDayKey(currentYear, currentMonth, day);
                const dayData = data[dayKey] || {};
                
                if (isDayHoliday(dayKey)) {
                    continue;
                }
                
                let hasDayData = false;
                WORKERS.forEach(worker => {
                    if (dayData[worker] !== undefined) {
                        stats[worker].total += dayData[worker];
                        stats[worker].days += 1;
                        totalSum += dayData[worker];
                        hasDayData = true;
                    }
                });
                
                if (hasDayData) {
                    daysWithData += 1;
                }
            }
            
            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            const prevStats = getMonthStatsForComparison(prevYear, prevMonth);
            
            const sortedWorkers = WORKERS.map(worker => ({
                name: worker,
                total: stats[worker].total,
                days: stats[worker].days,
                avg: stats[worker].days > 0 ? (stats[worker].total / stats[worker].days).toFixed(1) : 0,
                prevAvg: prevStats.workers[worker] ? prevStats.workers[worker].avg : 0
            })).sort((a, b) => b.total - a.total);
            
            const dailyAvg = daysWithData > 0 ? (totalSum / daysWithData).toFixed(1) : 0;
            const prevDailyAvg = prevStats.totalAvg;
            
            let comparisonHtml = '';
            if (daysWithData >= 3 && prevDailyAvg > 0) {
                const comparison = calculateComparison(parseFloat(dailyAvg), prevDailyAvg);
                comparisonHtml = `<div class="total-subtitle comparison-text ${comparison.class}">Poprz. mies.: ${prevDailyAvg} kg/dzień ${comparison.icon} ${comparison.text}</div>`;
            } else if (daysWithData >= 3) {
                comparisonHtml = `<div class="total-subtitle comparison-text">Poprz. mies.: brak danych</div>`;
            }
            
            const totalHtml = `
                <div class="total-card">
                    <div class="total-title">🏆 SUMA WSZYSTKICH</div>
                    <div class="total-value">${totalSum.toFixed(0)} kg</div>
                    <div class="total-subtitle">Średnia dzienna: ${dailyAvg} kg/dzień • ${daysWithData} dni z danymi</div>
                    ${comparisonHtml}
                </div>
            `;
            document.getElementById('totalCard').innerHTML = totalHtml;
            
            const medals = ['🥇', '🥈', '🥉', ''];
            let html = '';
            
            sortedWorkers.forEach((worker, index) => {
                const rank = index + 1;
                
                let workerComparisonHtml = '';
                if (worker.days >= 3 && worker.prevAvg > 0) {
                    const comparison = calculateComparison(parseFloat(worker.avg), worker.prevAvg);
                    workerComparisonHtml = `<div class="podium-label comparison-text ${comparison.class}">Poprz. mies.: ${worker.prevAvg} kg/dzień ${comparison.icon} ${comparison.text}</div>`;
                } else if (worker.days >= 3) {
                    workerComparisonHtml = `<div class="podium-label comparison-text">Poprz. mies.: brak danych</div>`;
                }
                
                html += `
                    <div class="podium-card rank-${rank} ${worker.name.toLowerCase()}">
                        <div class="podium-rank">${medals[index]}</div>
                        <div class="podium-name">${worker.name}</div>
                        <div class="podium-value">${worker.total.toFixed(0)} kg</div>
                        <div class="podium-label">Średnia: ${worker.avg} kg/dzień • ${worker.days} dni</div>
                        ${workerComparisonHtml}
                    </div>
                `;
            });
            
            document.getElementById('monthlyStats').innerHTML = html;
        }

        function getMonthStatsForComparison(year, month) {
            const data = getProductionData();
            const stats = {
                totalAvg: 0,
                total: 0,
                daysWithData: 0,
                workers: {}
            };
            
            let totalSum = 0;
            let daysWithData = 0;
            
            WORKERS.forEach(worker => {
                stats.workers[worker] = { total: 0, days: 0, avg: 0 };
            });
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const isCurrentMonth = (year === today.getFullYear() && month === today.getMonth());
            
            // Dla bieżącego miesiąca, znajdź ostatni kompletny dzień
            let maxDay = daysInMonth;
            if (isCurrentMonth) {
                const currentDay = today.getDate();
                let lastCompleteDay = 0;
                
                for (let day = 1; day <= currentDay; day++) {
                    const date = new Date(year, month, day);
                    const dayKey = getDayKey(year, month, day);
                    const dayData = data[dayKey] || {};
                    
                    let allWorkersReported = true;
                    let anyWorkerShouldWork = false;
                    
                    WORKERS.forEach(worker => {
                        const shift = getShiftForDay(worker, date);
                        if (shift !== 0) {
                            anyWorkerShouldWork = true;
                            if (dayData[worker] === undefined) {
                                allWorkersReported = false;
                            }
                        }
                    });
                    
                    if (anyWorkerShouldWork && allWorkersReported) {
                        lastCompleteDay = day;
                    }
                }
                
                maxDay = lastCompleteDay > 0 ? lastCompleteDay : currentDay;
            }
            
            for (let day = 1; day <= maxDay; day++) {
                const dayKey = getDayKey(year, month, day);
                const dayData = data[dayKey] || {};
                
                if (isDayHoliday(dayKey)) {
                    continue;
                }
                
                let hasDayData = false;
                WORKERS.forEach(worker => {
                    if (dayData[worker] !== undefined) {
                        stats.workers[worker].total += dayData[worker];
                        stats.workers[worker].days += 1;
                        totalSum += dayData[worker];
                        hasDayData = true;
                    }
                });
                
                if (hasDayData) {
                    daysWithData += 1;
                }
            }
            
            stats.totalAvg = daysWithData > 0 ? (totalSum / daysWithData).toFixed(1) : 0;
            stats.total = totalSum;
            stats.daysWithData = daysWithData;
            
            WORKERS.forEach(worker => {
                const workerStats = stats.workers[worker];
                workerStats.avg = workerStats.days > 0 ? (workerStats.total / workerStats.days).toFixed(1) : 0;
            });
            
            return stats;
        }

        function calculateComparison(current, previous) {
            const diff = current - previous;
            const percent = previous > 0 ? ((diff / previous) * 100).toFixed(1) : 0;
            
            if (percent >= 10) {
                return {
                    icon: '↗️',
                    text: `+${diff.toFixed(1)} kg (+${percent}%)`,
                    class: 'trend-up'
                };
            } else if (percent <= -10) {
                return {
                    icon: '↘️',
                    text: `${diff.toFixed(1)} kg (${percent}%)`,
                    class: 'trend-down'
                };
            } else if (percent > 0) {
                return {
                    icon: '↗️',
                    text: `+${diff.toFixed(1)} kg (+${percent}%)`,
                    class: 'trend-stable'
                };
            } else if (percent < 0) {
                return {
                    icon: '↘️',
                    text: `${diff.toFixed(1)} kg (${percent}%)`,
                    class: 'trend-stable'
                };
            } else {
                return {
                    icon: '➡️',
                    text: `${diff.toFixed(1)} kg (${percent}%)`,
                    class: 'trend-stable'
                };
            }
        }

        function renderCharts() {
            const data = getProductionData();
            const stats = {};
            const dailyData = {};
            
            WORKERS.forEach(worker => {
                stats[worker] = { total: 0, days: 0 };
                dailyData[worker] = [];
            });
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            
            // Określ maksymalny dzień do pokazania na wykresie
            let maxDay = daysInMonth;
            if (currentYear === today.getFullYear() && currentMonth === today.getMonth()) {
                // Jeśli to bieżący miesiąc, pokaż tylko do dziś
                maxDay = today.getDate();
            }
            
            for (let day = 1; day <= maxDay; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayKey = getDayKey(currentYear, currentMonth, day);
                const dayData = data[dayKey] || {};
                
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    const value = dayData[worker];
                    
                    // Jeśli dzień wolny - dodaj null (linia się przerywa)
                    // Jeśli dzień roboczy - dodaj wartość (lub 0 jeśli nie ma danych)
                    if (shift === 0) {
                        dailyData[worker].push(null);
                    } else {
                        dailyData[worker].push(value !== undefined ? value : null);
                    }
                    
                    if (value !== undefined) {
                        stats[worker].total += value;
                        stats[worker].days += 1;
                    }
                });
            }
            
            const comparisonCtx = document.getElementById('comparisonChart');
            if (!comparisonCtx) return;
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            comparisonChart = new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: WORKERS,
                    datasets: [{
                        label: 'Produkcja (kg)',
                        data: WORKERS.map(w => stats[w].total),
                        backgroundColor: [
                            'rgba(123, 237, 159, 0.8)',
                            'rgba(255, 165, 2, 0.8)',
                            'rgba(112, 161, 255, 0.8)',
                            'rgba(255, 99, 72, 0.8)'
                        ],
                        borderColor: [
                            'rgb(46, 213, 115)',
                            'rgb(255, 127, 0)',
                            'rgb(30, 144, 255)',
                            'rgb(255, 71, 87)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(0) + ' kg';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#b0b0b0',
                                callback: function(value) {
                                    return value + ' kg';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#b0b0b0',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                }
            });
            
            const trendCtx = document.getElementById('trendChart');
            if (!trendCtx) return;
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const days = Array.from({length: maxDay}, (_, i) => i + 1);
            
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: WORKERS.map((worker, idx) => ({
                        label: worker,
                        data: dailyData[worker],
                        borderColor: [
                            'rgb(46, 213, 115)',
                            'rgb(255, 127, 0)',
                            'rgb(30, 144, 255)',
                            'rgb(255, 71, 87)'
                        ][idx],
                        backgroundColor: [
                            'rgba(123, 237, 159, 0.1)',
                            'rgba(255, 165, 2, 0.1)',
                            'rgba(112, 161, 255, 0.1)',
                            'rgba(255, 99, 72, 0.1)'
                        ][idx],
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: [
                            'rgb(46, 213, 115)',
                            'rgb(255, 127, 0)',
                            'rgb(30, 144, 255)',
                            'rgb(255, 71, 87)'
                        ][idx],
                        spanGaps: true // ŁĄCZ linie przez dni wolne - ciągła linia!
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { 
                                color: '#b0b0b0',
                                font: { size: 11 },
                                padding: 10,
                                usePointStyle: true,
                                boxWidth: 6
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    if (context.parsed.y === null) {
                                        return context.dataset.label + ': Dzień wolny';
                                    }
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' kg';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#b0b0b0',
                                callback: function(value) {
                                    return value + ' kg';
                                }
                            }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#b0b0b0',
                                maxTicksLimit: 20
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function renderForecast() {
            const data = getProductionData();
            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
            
            if (!isCurrentMonth) {
                document.getElementById('forecastCard').innerHTML = '';
                return;
            }
            
            const currentDay = today.getDate();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Znajdź ostatni kompletny dzień z danymi
            let lastCompleteDay = 0;
            for (let day = 1; day <= currentDay; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayKey = getDayKey(currentYear, currentMonth, day);
                const dayData = data[dayKey] || {};
                
                let allWorkersReported = true;
                let anyWorkerShouldWork = false;
                
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    if (shift !== 0) {
                        anyWorkerShouldWork = true;
                        if (dayData[worker] === undefined) {
                            allWorkersReported = false;
                        }
                    }
                });
                
                if (anyWorkerShouldWork && allWorkersReported) {
                    lastCompleteDay = day;
                }
            }
            
            // Jeśli nie ma kompletnego dnia, użyj wszystkich dostępnych
            if (lastCompleteDay === 0) {
                lastCompleteDay = currentDay;
            }
            
            const daysRemaining = daysInMonth - lastCompleteDay;
            
            let totalSoFar = 0;
            let daysWithDataSoFar = 0;
            
            for (let day = 1; day <= lastCompleteDay; day++) {
                const dayKey = getDayKey(currentYear, currentMonth, day);
                const dayData = data[dayKey] || {};
                
                let hasDayData = false;
                WORKERS.forEach(worker => {
                    if (dayData[worker] !== undefined) {
                        totalSoFar += dayData[worker];
                        hasDayData = true;
                    }
                });
                
                if (hasDayData) {
                    daysWithDataSoFar += 1;
                }
            }
            
            if (daysWithDataSoFar === 0) {
                document.getElementById('forecastCard').innerHTML = '';
                return;
            }
            
            const avgPerDay = totalSoFar / daysWithDataSoFar;
            
            let estimatedRemainingDays = 0;
            for (let day = lastCompleteDay + 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayKey = getDayKey(currentYear, currentMonth, day);
                
                if (isDayHoliday(dayKey)) continue;
                
                let hasWorkingPeople = false;
                WORKERS.forEach(worker => {
                    const shift = getShiftForDay(worker, date);
                    if (shift !== 0) hasWorkingPeople = true;
                });
                if (hasWorkingPeople) estimatedRemainingDays += 1;
            }
            
            const forecastTotal = totalSoFar + (avgPerDay * estimatedRemainingDays);
            
            const html = `
                <div class="forecast-card">
                    <div class="forecast-title">🔮 Prognoza na koniec miesiąca</div>
                    <div class="forecast-value">${forecastTotal.toFixed(0)} kg</div>
                    <div class="forecast-subtitle">
                        W tym tempie (${avgPerDay.toFixed(1)} kg/dzień) 
                        • Pozostało ${estimatedRemainingDays} dni roboczych
                    </div>
                </div>
            `;
            
            document.getElementById('forecastCard').innerHTML = html;
        }

        function renderYearlyStats() {
            const data = getProductionData();
            const monthlyStats = [];
            const yearlyTotals = {};
            
            WORKERS.forEach(worker => {
                yearlyTotals[worker] = 0;
            });
            
            for (let month = 0; month < 12; month++) {
                const monthData = {};
                let monthTotal = 0;
                
                WORKERS.forEach(worker => {
                    monthData[worker] = 0;
                });
                
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayKey = getDayKey(currentYear, month, day);
                    const dayData = data[dayKey] || {};
                    
                    WORKERS.forEach(worker => {
                        if (dayData[worker] !== undefined) {
                            monthData[worker] += dayData[worker];
                            yearlyTotals[worker] += dayData[worker];
                        }
                    });
                }
                
                WORKERS.forEach(worker => {
                    monthTotal += monthData[worker];
                });
                
                monthlyStats.push({
                    month: MONTHS[month],
                    data: monthData,
                    total: monthTotal
                });
            }
            
            const sortedWorkers = WORKERS.map(worker => ({
                name: worker,
                total: yearlyTotals[worker]
            })).sort((a, b) => b.total - a.total);
            
            let yearTotal = 0;
            const workerDays = {};
            WORKERS.forEach(worker => workerDays[worker] = 0);
            
            for (let month = 0; month < 12; month++) {
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayKey = getDayKey(currentYear, month, day);
                    const dayData = data[dayKey] || {};
                    
                    WORKERS.forEach(worker => {
                        if (dayData[worker] !== undefined) {
                            workerDays[worker] += 1;
                        }
                    });
                }
            }
            
            yearTotal = sortedWorkers.reduce((sum, w) => sum + w.total, 0);
            
            const daysWithData = new Set();
            for (let month = 0; month < 12; month++) {
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayKey = getDayKey(currentYear, month, day);
                    const dayData = data[dayKey] || {};
                    
                    let hasDayData = false;
                    WORKERS.forEach(worker => {
                        if (dayData[worker] !== undefined) {
                            hasDayData = true;
                        }
                    });
                    
                    if (hasDayData) {
                        daysWithData.add(dayKey);
                    }
                }
            }
            
            const totalDaysWithData = daysWithData.size;
            const yearlyAvg = totalDaysWithData > 0 ? (yearTotal / totalDaysWithData).toFixed(1) : 0;
            
            const today = new Date();
            let fullMonthsCount = 0;

            for (let month = 0; month < 12; month++) {
                const isCurrentMonth = (month === today.getMonth() && currentYear === today.getFullYear());
                const lastDayOfMonth = new Date(currentYear, month + 1, 0).getDate();
                const isFullMonth = !isCurrentMonth || today.getDate() >= lastDayOfMonth;
                
                if (monthlyStats[month].total > 0 && isFullMonth) {
                    fullMonthsCount++;
                }
            }

            let fullMonthsTotal = 0;
            for (let month = 0; month < 12; month++) {
                const isCurrentMonth = (month === today.getMonth() && currentYear === today.getFullYear());
                const lastDayOfMonth = new Date(currentYear, month + 1, 0).getDate();
                const isFullMonth = !isCurrentMonth || today.getDate() >= lastDayOfMonth;
                
                if (monthlyStats[month].total > 0 && isFullMonth) {
                    fullMonthsTotal += monthlyStats[month].total;
                }
            }

            const monthlyAvg = fullMonthsCount > 0 ? (fullMonthsTotal / fullMonthsCount).toFixed(0) : 0;
            const isCurrentYearIncomplete = currentYear === today.getFullYear() && today.getMonth() < 11;

            let monthlyAvgText = '';
            if (fullMonthsCount > 0) {
                monthlyAvgText = `Średnia miesięczna: ${monthlyAvg} kg/miesiąc • ${fullMonthsCount} ${fullMonthsCount === 1 ? 'pełny miesiąc' : 'pełne miesiące'}`;
                if (isCurrentYearIncomplete && fullMonthsCount < 12) {
                    const currentMonthName = MONTHS[today.getMonth()];
                    monthlyAvgText += `<br><span style="font-size: 0.85rem; opacity: 0.7;">${currentMonthName} w trakcie - nie liczony do średniej</span>`;
                }
            }
            
            const totalHtml = `
                <div class="total-card">
                    <div class="total-title">🏆 SUMA ROCZNA ${currentYear}</div>
                    <div class="total-value">${yearTotal.toFixed(0)} kg</div>
                    <div class="total-subtitle">
                        Średnia dzienna: ${yearlyAvg} kg/dzień • ${totalDaysWithData} dni z danymi<br>
                        ${monthlyAvgText}
                    </div>
                </div>
            `;
            document.getElementById('yearlyTotalCard').innerHTML = totalHtml;
            
            const medals = ['🥇', '🥈', '🥉', ''];
            let rankingHtml = '';
            
            sortedWorkers.forEach((worker, index) => {
                const rank = index + 1;
                const days = workerDays[worker.name];
                const avg = days > 0 ? (worker.total / days).toFixed(1) : 0;

                let workerFullMonths = 0;
                let workerFullMonthsTotal = 0;
                for (let month = 0; month < 12; month++) {
                    const isCurrentMonth = (month === today.getMonth() && currentYear === today.getFullYear());
                    const lastDayOfMonth = new Date(currentYear, month + 1, 0).getDate();
                    const isFullMonth = !isCurrentMonth || today.getDate() >= lastDayOfMonth;
                    
                    if (isFullMonth && monthlyStats[month].data[worker.name] > 0) {
                        workerFullMonths++;
                        workerFullMonthsTotal += monthlyStats[month].data[worker.name];
                    }
                }

                const monthlyAvgWorker = workerFullMonths > 0 ? (workerFullMonthsTotal / workerFullMonths).toFixed(0) : 0;
        
                let monthlyAvgHtml = '';
                if (workerFullMonths > 0) {
                    monthlyAvgHtml = `<div class="podium-label">Średnia miesięczna: ${monthlyAvgWorker} kg/miesiąc • ${workerFullMonths} ${workerFullMonths === 1 ? 'miesiąc' : 'miesięcy'}</div>`;
                }
                
                rankingHtml += `
                    <div class="podium-card rank-${rank} ${worker.name.toLowerCase()}">
                        <div class="podium-rank">${medals[index]}</div>
                        <div class="podium-name">${worker.name}</div>
                        <div class="podium-value">${worker.total.toFixed(0)} kg</div>
                        <div class="podium-label">Średnia dzienna: ${avg} kg/dzień • ${days} dni</div>
                        ${monthlyAvgHtml}
                    </div>
                `;
            });
            
            document.getElementById('yearlyStats').innerHTML = rankingHtml;
            
            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Miesiąc</th>
                            <th class="kamil-col" style="background: rgba(123, 237, 159, 0.2);">Kamil</th>
                            <th class="igor-col" style="background: rgba(255, 165, 2, 0.2);">Igor</th>
                            <th class="jarek-col" style="background: rgba(112, 161, 255, 0.2);">Jarek</th>
                            <th class="wowa-col" style="background: rgba(255, 99, 72, 0.2);">Wowa</th>
                            <th class="sum-col" style="background: rgba(255, 215, 0, 0.3);">SUMA</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            monthlyStats.forEach(month => {
                tableHtml += `<tr>`;
                tableHtml += `<td><strong>${month.month}</strong></td>`;
                WORKERS.forEach(worker => {
                    tableHtml += `<td class="${worker.toLowerCase()}-col">${month.data[worker].toFixed(0)} kg</td>`;
                });
                tableHtml += `<td class="sum-col">${month.total.toFixed(0)} kg</td>`;
                tableHtml += `</tr>`;
            });
            
            tableHtml += `<tr class="total-row">`;
            tableHtml += `<td><strong>RAZEM</strong></td>`;
            WORKERS.forEach(worker => {
                tableHtml += `<td><strong>${yearlyTotals[worker].toFixed(0)} kg</strong></td>`;
            });
            tableHtml += `<td><strong>${yearTotal.toFixed(0)} kg</strong></td>`;
            tableHtml += `</tr>`;
            
            tableHtml += `</tbody></table>`;
            
            document.getElementById('yearlyTable').innerHTML = tableHtml;
            document.getElementById('yearlyTitle').textContent = currentYear;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            document.getElementById('yearSelect').value = currentYear;
            renderCalendar();
        }

        function changeYear() {
            currentYear = parseInt(document.getElementById('yearSelect').value);
            renderCalendar();
            if (document.getElementById('yearlyView').style.display !== 'none') {
                renderYearlyStats();
            }
        }

        function showView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('monthlyView').style.display = 'none';
            document.getElementById('yearlyView').style.display = 'none';
            document.getElementById('analyticsView').style.display = 'none';
            
            if (view === 'dashboard') {
                document.getElementById('dashboardView').style.display = 'block';
                renderDashboard();
            } else if (view === 'monthly') {
                document.getElementById('monthlyView').style.display = 'block';
                renderCalendar();
            } else if (view === 'yearly') {
                document.getElementById('yearlyView').style.display = 'block';
                renderYearlyStats();
            } else if (view === 'analytics') {
                document.getElementById('analyticsView').style.display = 'block';
                renderAnalytics();
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        }

        function exportData() {
            const productionData = getProductionData();
            const customSchedules = JSON.parse(localStorage.getItem('customSchedules') || '{}');
            
            const exportObj = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                productionData: productionData,
                customSchedules: customSchedules
            };
            
            const dataStr = JSON.stringify(exportObj, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `produkcja_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('💾 Backup pobrany!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (typeof importedData !== 'object') {
                        throw new Error('Nieprawidłowy format danych');
                    }
                    
                    if (confirm('⚠️ UWAGA!\n\nImport nadpisze wszystkie obecne dane!\n\nCzy chcesz kontynuować?')) {
                        if (importedData.productionData) {
                            setProductionData(importedData.productionData);
                        } else {
                            setProductionData(importedData);
                        }
                        
                        if (importedData.customSchedules) {
                            localStorage.setItem('customSchedules', JSON.stringify(importedData.customSchedules));
                        }
                        
                        renderCalendar();
                        showToast('✅ Dane zaimportowane!');
                    }
                } catch (error) {
                    alert('❌ Błąd importu: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        window.onload = function() {
            initData();
            
            // Load data from Firebase
            if (isFirebaseInitialized) {
                loadFromFirebase();
                setupFirebaseListeners();
                updateSyncStatus('synced', 'Połączono');
            } else {
                updateSyncStatus('error', 'Tryb offline');
            }
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
            
            document.getElementById('yearSelect').value = currentYear;
            renderDashboard();
        };

        window.onclick = function(event) {
            const modal = document.getElementById('productionModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('productionModal');
            if (modal.classList.contains('active') && event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>